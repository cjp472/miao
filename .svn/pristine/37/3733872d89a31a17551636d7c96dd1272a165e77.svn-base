package com.liuzhuni.lzn.db;

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;

import java.util.ArrayList;
import java.util.List;

/**
 * Created by Andrew Lee on 2015/5/30.
 * E-mail:jieooo7@163.com
 * Date: 2015-05-30
 * Time: 17:40
 */
public class DatabaseOperate {

    public static void insert(SQLiteDatabase db, DbModel model) {
        delete(db);

        db.beginTransaction(); // 事务处理
        try {//insert or ignore into
            db.execSQL(
                    "REPLACE INTO goods_record VALUES(?, ?,?,?,?)",
                    new Object[]{model.getMessage_id(), model.getBody_id(),model.getText(),model.getDate(),model.getBody()});
            db.setTransactionSuccessful(); // 成功
        } finally {
            db.endTransaction(); // 结束事务
        }

    }


    public static void delete(SQLiteDatabase db) {
        Cursor c = db.rawQuery("SELECT message_id FROM goods_record", null);
        int count = c.getCount();

        if (count > 100) {
            int limit = count - 100;
            Cursor cc = db.rawQuery("SELECT message_id FROM goods_record ORDER BY message_id ASC limit " + Integer.toString(limit), null);
            while (cc.moveToNext()) {
                db.execSQL("DELETE FROM goods_record WHERE message_id=" +Integer.toString(cc.getInt(cc.getColumnIndex("message_id"))));//子查询无法使用
//                String[] args = {String.valueOf(cc.getInt(cc.getColumnIndex("message_id")))};
//                db.delete("goods_record","message_id=?",args);
            }
            cc.close();
        }
        c.close();

    }

    public static List<DbModel> getDb(SQLiteDatabase db) { //返回 5条数据 由大到小排列
        Cursor c=null;

           c = db.rawQuery("SELECT * FROM goods_record ORDER BY message_id DESC limit 5" , null);
        List<DbModel> list = new ArrayList<DbModel>();
        while (c.moveToNext()) {
            list.add(new DbModel(c.getInt(c.getColumnIndex("message_id")), c.getInt(c.getColumnIndex("body_id")),c.getString(c.getColumnIndex("body")),c.getString(c.getColumnIndex("text")),c.getString(c.getColumnIndex("date"))));
        }

        c.close();

        return list;
    }




}
